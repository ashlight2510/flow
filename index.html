<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Flow â€” í˜ë¦° ë§ í•˜ë‚˜ê°€, ìŠ¤í† ë¦¬ê°€ ë˜ëŠ” ê³³</title>

    <!-- âœ… SEO / OG / Twitter / Canonical (ë„ë©”ì¸ë§Œ êµì²´) -->
    <meta
      name="description"
      content="í˜ë¦° ë§ í•˜ë‚˜ê°€, ìŠ¤í† ë¦¬ê°€ ë˜ëŠ” ê³³ â€” Flow ìµëª… ì»¤ë®¤ë‹ˆí‹°"
    />
    <meta
      name="keywords"
      content="ìµëª… ì»¤ë®¤ë‹ˆí‹°, ê²Œì‹œíŒ, ê°¤ëŸ¬ë¦¬, ìŠ¤ë ˆë“œ, í”¼ë“œ, DC, Threads, ìµëª… ê¸€, ìµëª… ëŒ“ê¸€, Flow"
    />
    <meta name="author" content="FunnyFunny" />
    <link rel="canonical" href="https://flow.funnyfunny.cloud/" />

    <meta property="og:title" content="Flow â€” ê¸€ì€ íë¥´ê³ , íŒì€ ë‚¨ëŠ”ë‹¤" />
    <meta
      property="og:description"
      content="ìŠ¤ì³ê°€ëŠ” ë§ì´, ì£¼ì œê°€ ëœë‹¤. ìµëª… í”¼ë“œ ì»¤ë®¤ë‹ˆí‹° Flow"
    />
    <!-- âœ… OG ì´ë¯¸ì§€ëŠ” dummyimage.com ì‚¬ìš©(ìš”ì²­ ë©”ëª¨ ë°˜ì˜) -->
    <meta
      property="og:image"
      content="https://dummyimage.com/1200x630/0b1220/ffffff&text=FLOW"
    />
    <meta property="og:image:alt" content="FLOW" />
    <meta property="og:type" content="website" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="Flow â€” í˜ë¦° ë§ í•˜ë‚˜ê°€, ìŠ¤í† ë¦¬ê°€ ë˜ëŠ” ê³³"
    />
    <meta
      name="twitter:description"
      content="ìŠ¤ì³ê°€ëŠ” ë§ì´, ì£¼ì œê°€ ëœë‹¤. ìµëª… í”¼ë“œ ì»¤ë®¤ë‹ˆí‹° Flow"
    />
    <meta
      name="twitter:image"
      content="https://dummyimage.com/1200x630/0b1220/ffffff&text=FLOW"
    />

    <!-- âœ… Favicon -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='50' font-size='48'%3E%F0%9F%8C%8A%3C/text%3E%3C/svg%3E"
    />

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Supabase JS v2 (UMD) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
      :root {
        color-scheme: dark;
      }
      body {
        background: radial-gradient(
            1200px 600px at 20% 0%,
            rgba(56, 189, 248, 0.12),
            transparent 50%
          ),
          radial-gradient(
            900px 500px at 80% 20%,
            rgba(244, 114, 182, 0.1),
            transparent 50%
          ),
          #050814;
      }
      .glass {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .soft {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      }
      .tap {
        transition: transform 120ms ease, opacity 120ms ease;
      }
      .tap:active {
        transform: scale(0.99);
        opacity: 0.92;
      }
      .skeleton {
        animation: pulse 1.2s ease-in-out infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 0.45;
        }
        50% {
          opacity: 0.8;
        }
      }
      .modal-overlay {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(6px);
      }
      .modal-card {
        background: rgba(5, 8, 20, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.16);
      }
    </style>
  </head>

  <body class="min-h-screen text-slate-100">
    <!-- Top bar -->
    <header
      class="sticky top-0 z-40 backdrop-blur-xl bg-black/20 border-b border-white/10"
    >
      <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
        <a
          href="#/"
          class="tap inline-flex items-center gap-2 font-black tracking-tight"
        >
          <span class="text-xl">ğŸŒŠ</span>
          <span class="text-lg">Flow</span>
          <span
            class="text-xs font-semibold px-2 py-1 rounded-full bg-white/10 border border-white/10"
            >BETA</span
          >
        </a>

        <div class="ml-auto flex items-center gap-2">
          <!-- âœ… ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ë³´ê¸° ë²„íŠ¼(ê¸°ë³¸ í¬í•¨) -->
          <a
            id="moreServicesBtn"
            href="https://funnyfunny.cloud/"
            target="_blank"
            rel="noopener noreferrer"
            class="tap hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15"
          >
            <span>ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ë³´ê¸°</span>
            <span class="opacity-70">â†—</span>
          </a>

          <button
            id="openComposeBtn"
            class="tap inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-sky-400/20 border border-sky-300/30 hover:bg-sky-400/25"
          >
            âœï¸ ê¸€ì“°ê¸°
          </button>
        </div>
      </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-6">
      <!-- Status row -->
      <section class="flex flex-col sm:flex-row gap-3 items-stretch">
        <div class="glass soft rounded-2xl p-4 flex-1">
          <div class="flex items-center justify-between gap-4">
            <div>
              <p class="text-sm text-slate-300">
                í˜ë¦° ë§ í•˜ë‚˜ê°€, ìŠ¤í† ë¦¬ê°€ ë˜ëŠ” ê³³
              </p>
              <h1 class="text-xl font-extrabold tracking-tight">
                Flow - ìµëª…ì»¤ë®¤ë‹ˆí‹°
              </h1>
            </div>
            <div class="hidden sm:flex items-center gap-2">
              <span
                id="anonBadge"
                class="text-xs px-2 py-1 rounded-full bg-white/10 border border-white/10"
                >anon: -</span
              >
              <button
                id="copyAnonBtn"
                class="tap text-xs px-2 py-1 rounded-full bg-white/10 border border-white/10 hover:bg-white/15"
              >
                ID ë³µì‚¬
              </button>
            </div>
          </div>

          <div class="mt-3 flex flex-wrap items-center gap-2">
            <button
              data-tab="home"
              class="tabBtn tap text-sm px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15"
            >
              ğŸ  í”¼ë“œ
            </button>
            <button
              data-tab="boards"
              class="tabBtn tap text-sm px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15"
            >
              ğŸ§© ì‚´ì•„ìˆëŠ” íŒ
            </button>
            <button
              data-tab="new-board"
              class="tabBtn tap text-sm px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15"
            >
              â• íŒ ë§Œë“¤ê¸°
            </button>
          </div>

          <p class="mt-3 text-xs text-slate-400 leading-relaxed">
            âœ… ê³„ì • ì—†ìŒ Â· ìµëª… Â· ì£¼ì œ(íŒ) ì¤‘ì‹¬ Â· 24ì‹œê°„ ë¬´í™œë™ íŒì€ ìˆ¨ê¹€(ìš´ì˜
            ì •ì±…ì— ë”°ë¼ ì¡°ì •).
          </p>
        </div>

        <!-- Right info card -->
        <div class="glass soft rounded-2xl p-4 sm:w-[320px]">
          <div class="flex items-center justify-between">
            <p class="text-sm text-slate-300">ì˜¤ëŠ˜ì˜ íë¦„</p>
            <!-- <span
              class="text-xs px-2 py-1 rounded-full bg-white/10 border border-white/10"
              >MVP</span
            > -->
          </div>
          <div class="mt-3 grid grid-cols-3 gap-2 text-center">
            <div class="rounded-xl bg-white/5 border border-white/10 p-2">
              <div id="statBoards" class="text-lg font-extrabold">-</div>
              <div class="text-xs text-slate-400">íŒ</div>
            </div>
            <div class="rounded-xl bg-white/5 border border-white/10 p-2">
              <div id="statPosts" class="text-lg font-extrabold">-</div>
              <div class="text-xs text-slate-400">ê¸€</div>
            </div>
            <div class="rounded-xl bg-white/5 border border-white/10 p-2">
              <div id="statComments" class="text-lg font-extrabold">-</div>
              <div class="text-xs text-slate-400">ëŒ“ê¸€</div>
            </div>
          </div>

          <div class="mt-3 text-xs text-slate-400">
            <p class="leading-relaxed">ê¸€ì„ ì“°ë©´ ìƒê°ì´ ì •ë¦¬ ë¼</p>
          </div>
        </div>
      </section>

      <!-- Router outlet -->
      <section id="view" class="mt-5"></section>

      <!-- Footer -->
      <footer class="mt-10 pb-10 text-center text-xs text-slate-500">
        <p>Â© FunnyFunny Â· ìµëª… ê¸°ë°˜ ì»¤ë®¤ë‹ˆí‹°</p>
      </footer>
    </main>

    <!-- Compose Modal -->
    <div id="composeModal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 modal-overlay"></div>
      <div
        class="absolute inset-0 flex items-end sm:items-center justify-center p-4"
      >
        <div
          class="glass soft modal-card w-full max-w-2xl rounded-2xl overflow-hidden"
        >
          <div
            class="p-4 border-b border-white/10 flex items-center justify-between"
          >
            <div>
              <h3 class="text-lg font-extrabold">âœï¸ ê¸€ì“°ê¸°</h3>
              <p class="text-xs text-slate-400">íŒì„ ê³ ë¥´ê³ , í•œ ë²ˆì— íˆ­.</p>
            </div>
            <button
              id="closeComposeBtn"
              class="tap px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15"
            >
              ë‹«ê¸°
            </button>
          </div>

          <div class="p-4 space-y-3">
            <div class="grid sm:grid-cols-2 gap-3">
              <label class="block">
                <span class="text-xs text-slate-400">ë‹‰ë„¤ì„(ì„ íƒ)</span>
                <input
                  id="composeName"
                  maxlength="20"
                  placeholder="ìµëª…"
                  class="mt-1 w-full px-3 py-2 rounded-xl bg-black/30 border border-white/10 outline-none focus:border-sky-300/40"
                />
              </label>

              <label class="block">
                <span class="text-xs text-slate-400">íŒ ì„ íƒ</span>
                <select
                  id="composeBoard"
                  class="mt-1 w-full px-3 py-2 rounded-xl bg-black/30 border border-white/10 outline-none focus:border-sky-300/40"
                >
                  <option value="">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
                </select>
              </label>
            </div>

            <label class="block">
              <span class="text-xs text-slate-400">ë³¸ë¬¸</span>
              <textarea
                id="composeBody"
                rows="5"
                maxlength="8000"
                placeholder="ìš”ì¦˜ ë“œëŠ” ìƒê° í•œ ì¤„â€¦"
                class="mt-1 w-full px-3 py-2 rounded-xl bg-black/30 border border-white/10 outline-none focus:border-sky-300/40"
              ></textarea>
              <div class="mt-1 flex justify-between text-xs text-slate-500">
                <span id="composeHint">ì¿¨íƒ€ì„: ê¸€ 20ì´ˆ</span>
                <span id="composeCount">0/8000</span>
              </div>
            </label>

            <div class="flex items-center justify-end gap-2">
              <button
                id="goNewBoardBtn"
                class="tap px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15"
              >
                íŒ ë¨¼ì € ë§Œë“¤ê¸°
              </button>
              <button
                id="submitPostBtn"
                class="tap px-4 py-2 rounded-xl bg-sky-400/20 border border-sky-300/30 hover:bg-sky-400/25 font-bold"
              >
                ê²Œì‹œ
              </button>
            </div>

            <p id="composeError" class="hidden text-xs text-rose-300"></p>
          </div>
        </div>
      </div>
    </div>

    <script>
      /**
       * ============================
       * âœ… 0) Supabase ì—°ê²° ì •ë³´ ë„£ê¸°
       * ============================
       * Supabase ëŒ€ì‹œë³´ë“œ â†’ Settings â†’ API
       * - Project URL
       * - anon public key
       */
      const SUPABASE_URL = "https://vpezjsuzwmeozaytcqyv.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwZXpqc3V6d21lb3pheXRjcXl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMDA0OTIsImV4cCI6MjA3OTY3NjQ5Mn0.Fyjj5yrV2-6w1OKnQXWaL_-7_r1XpuUl-UQq6e6e5vc";
      const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      /**
       * ============================
       * âœ… 1) ìµëª…ID / ì¿¨íƒ€ì„
       * ============================
       */
      const LS_ANON = "panfeed_anon_id";
      const LS_NAME = "panfeed_last_name";
      const LS_COOLDOWN_POST = "panfeed_cd_post";
      const LS_COOLDOWN_COMMENT = "panfeed_cd_comment";

      function getAnonId() {
        let v = localStorage.getItem(LS_ANON);
        if (!v) {
          v =
            crypto?.randomUUID?.() ||
            Date.now() + "-" + Math.random().toString(16).slice(2);
          localStorage.setItem(LS_ANON, v);
        }
        return v;
      }
      function setLastName(name) {
        if (!name) return;
        localStorage.setItem(LS_NAME, name.slice(0, 20));
      }
      function getLastName() {
        return localStorage.getItem(LS_NAME) || "";
      }
      function nowMs() {
        return Date.now();
      }

      function inCooldown(key, ms) {
        const until = Number(localStorage.getItem(key) || "0");
        return nowMs() < until;
      }
      function setCooldown(key, ms) {
        localStorage.setItem(key, String(nowMs() + ms));
      }
      function msLeft(key) {
        const until = Number(localStorage.getItem(key) || "0");
        return Math.max(0, until - nowMs());
      }

      const anonId = getAnonId();

      /**
       * ============================
       * âœ… 2) DOM helpers
       * ============================
       */
      const $ = (sel) => document.querySelector(sel);
      const viewEl = $("#view");

      function esc(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
      function timeAgo(iso) {
        const t = new Date(iso).getTime();
        const diff = Math.max(0, Date.now() - t);
        const m = Math.floor(diff / 60000);
        if (m < 1) return "ë°©ê¸ˆ";
        if (m < 60) return `${m}ë¶„ ì „`;
        const h = Math.floor(m / 60);
        if (h < 24) return `${h}ì‹œê°„ ì „`;
        const d = Math.floor(h / 24);
        return `${d}ì¼ ì „`;
      }
      function seedImg(seed) {
        // âœ… ë³¸ë¬¸ ë”ë¯¸ ì´ë¯¸ì§€ëŠ” picsum ì‚¬ìš©(ì˜ë¬¸/ìˆ«ì seed)
        const s = encodeURIComponent(
          String(seed).replace(/[^a-z0-9-]/gi, "seed")
        );
        return `https://picsum.photos/seed/${s}/1200/700`;
      }

      /**
       * ============================
       * âœ… 3) ë¼ìš°íŒ…
       * ============================
       */
      function parseHash() {
        const h = (location.hash || "#/").slice(1);
        const parts = h.split("/").filter(Boolean);
        return parts;
      }

      function nav(path) {
        location.hash = path.startsWith("#") ? path : "#" + path;
      }

      document.querySelectorAll(".tabBtn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          if (tab === "home") nav("/");
          if (tab === "boards") nav("/boards");
          if (tab === "new-board") nav("/boards/new");
        });
      });

      /**
       * ============================
       * âœ… 4) ìƒë‹¨ ìµëª…ID ë±ƒì§€
       * ============================
       */
      $("#anonBadge").textContent = `anon: ${anonId.slice(0, 8)}`;
      $("#copyAnonBtn").addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(anonId);
          $("#copyAnonBtn").textContent = "ë³µì‚¬ë¨!";
          setTimeout(() => ($("#copyAnonBtn").textContent = "ID ë³µì‚¬"), 900);
        } catch {
          alert("ë³µì‚¬ ì‹¤íŒ¨. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì¤˜.");
        }
      });

      /**
       * ============================
       * âœ… 5) í†µê³„
       * ============================
       */
      async function loadStats() {
        // countëŠ” head:trueë¡œ ë¹ ë¥´ê²Œ
        const boards = await sb
          .from("boards")
          .select("id", { count: "exact", head: true });
        const posts = await sb
          .from("posts")
          .select("id", { count: "exact", head: true });
        const comments = await sb
          .from("comments")
          .select("id", { count: "exact", head: true });

        $("#statBoards").textContent = boards.count ?? "-";
        $("#statPosts").textContent = posts.count ?? "-";
        $("#statComments").textContent = comments.count ?? "-";
      }

      /**
       * ============================
       * âœ… 6) ë°ì´í„° ë¡œë”
       * ============================
       */
      async function fetchActiveBoards(limit = 30) {
        const { data, error } = await sb
          .from("boards")
          .select(
            "id, slug, title, description, tags, is_active, last_activity_at, created_at"
          )
          .eq("is_active", true)
          .order("last_activity_at", { ascending: false })
          .limit(limit);
        if (error) throw error;
        return data || [];
      }

      async function fetchFeed({ limit = 30, boardSlug = null } = {}) {
        // posts + board join
        let q = sb
          .from("posts")
          .select(
            "id, body, author_name, anon_id, created_at, comment_count, empathy_count, is_hidden, board:boards(id, slug, title)"
          )
          .eq("is_hidden", false)
          .order("created_at", { ascending: false })
          .limit(limit);

        if (boardSlug) {
          // filter by board slug: need inner join filter
          // Supabase: use foreignTable filter via !inner
          q = sb
            .from("posts")
            .select(
              "id, body, author_name, anon_id, created_at, comment_count, empathy_count, is_hidden, board:boards!inner(id, slug, title)"
            )
            .eq("is_hidden", false)
            .eq("boards.slug", boardSlug)
            .order("created_at", { ascending: false })
            .limit(limit);
        }

        const { data, error } = await q;
        if (error) throw error;
        return data || [];
      }

      async function fetchPostDetail(postId) {
        if (!postId) {
          throw new Error("ê¸€ IDê°€ í•„ìš”í•´.");
        }
        const { data: post, error: e1 } = await sb
          .from("posts")
          .select(
            "id, body, author_name, anon_id, created_at, comment_count, empathy_count, is_hidden, board:boards(id, slug, title)"
          )
          .eq("id", postId)
          .maybeSingle();
        if (e1) throw e1;

        const { data: comments, error: e2 } = await sb
          .from("comments")
          .select("id, body:content, author_name, anon_id, created_at")
          .eq("post_id", postId)
          .order("created_at", { ascending: true });
        if (e2) throw e2;

        return { post, comments: comments || [] };
      }

      async function fetchBoardsForSelect() {
        const { data, error } = await sb
          .from("boards")
          .select("id, slug, title, is_active, last_activity_at")
          .eq("is_active", true)
          .order("last_activity_at", { ascending: false })
          .limit(80);
        if (error) throw error;
        return data || [];
      }

      /**
       * ============================
       * âœ… 7) UI ì»´í¬ë„ŒíŠ¸
       * ============================
       */
      function cardShell(inner) {
        return `
    <div class="glass soft rounded-2xl overflow-hidden">
      ${inner}
    </div>
  `;
      }

      function postCard(p) {
        const board = p.board || {};
        const nick = p.author_name || "ìµëª…";
        const ago = timeAgo(p.created_at);
        const short = (p.body || "").trim();
        const preview = short.length > 220 ? short.slice(0, 220) + "â€¦" : short;

        return `
    <article class="glass rounded-2xl border border-white/10 hover:border-white/15 soft overflow-hidden cursor-pointer" 
             onclick="location.hash='#/p/${esc(p.id)}'">
      <div class="p-4">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="flex flex-wrap items-center gap-2 text-xs text-slate-400">
              <span class="px-2 py-1 rounded-full bg-white/10 border border-white/10">${esc(
                nick
              )}</span>
              <span>Â·</span>
              <span>${esc(ago)}</span>
              <span class="hidden sm:inline">Â·</span>
              <a class="tap hidden sm:inline-flex items-center gap-1 px-2 py-1 rounded-full bg-white/5 border border-white/10 hover:bg-white/10"
                 href="#/g/${esc(board.slug || "")}"
                 onclick="event.stopPropagation()">
                ğŸ“Œ <span class="truncate max-w-[220px]">${esc(
                  board.title || "íŒ"
                )}</span>
              </a>
            </div>

            <div class="mt-3">
              <p class="text-base leading-relaxed whitespace-pre-wrap">${esc(
                preview
              )}</p>
            </div>
          </div>

          <img src="${seedImg((board.slug || "board") + "-" + p.id)}"
               alt="post image"
               class="hidden sm:block w-28 h-20 rounded-xl object-cover border border-white/10 opacity-95" />
        </div>

        <div class="mt-4 flex flex-wrap items-center gap-2" onclick="event.stopPropagation()">
          <button class="tap empathyBtn px-3 py-2 rounded-xl bg-rose-400/10 border border-rose-300/20 hover:bg-rose-400/15 text-sm"
                  data-post="${esc(p.id)}">
            ğŸ”¥ ê³µê° <span class="opacity-80" data-empathy-count="${esc(
              p.id
            )}">(${Number(p.empathy_count || 0)})</span>
          </button>

          <a href="#/p/${esc(
            p.id
          )}" class="tap px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15 text-sm">
            ğŸ’¬ ëŒ“ê¸€ <span class="opacity-80">(${Number(
              p.comment_count || 0
            )})</span>
          </a>

          <a href="#/g/${esc(
            board.slug || ""
          )}" class="tap px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 text-sm">
            ğŸ§© íŒìœ¼ë¡œ
          </a>

          <button class="tap reportBtn ml-auto px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 text-sm"
                  data-type="post" data-id="${esc(p.id)}">
            ğŸš« ì‹ ê³ 
          </button>
        </div>
      </div>
    </article>
  `;
      }

      function boardPill(b) {
        const ago = timeAgo(b.last_activity_at);
        return `
    <a href="#/g/${esc(
      b.slug
    )}" class="tap block rounded-2xl bg-white/5 border border-white/10 hover:bg-white/10 p-4">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="flex items-center gap-2">
            <h4 class="font-extrabold text-base truncate">${esc(b.title)}</h4>
            <span class="text-xs text-slate-400">Â· ${esc(ago)}</span>
          </div>
          <p class="mt-1 text-sm text-slate-300 line-clamp-2">${esc(
            b.description || ""
          )}</p>
          <div class="mt-2 flex flex-wrap gap-1">
            ${(b.tags || [])
              .slice(0, 6)
              .map(
                (t) =>
                  `<span class="text-xs px-2 py-1 rounded-full bg-white/5 border border-white/10">${esc(
                    t
                  )}</span>`
              )
              .join("")}
          </div>
        </div>
        <img src="${seedImg("board-" + b.slug)}" alt="board image"
             class="w-20 h-16 rounded-xl object-cover border border-white/10 opacity-95" />
      </div>
      <div class="mt-3 text-xs text-slate-500">#${esc(b.slug)}</div>
    </a>
  `;
      }

      /**
       * ============================
       * âœ… 8) ì•¡ì…˜(ê³µê°/ì‹ ê³ /ì‘ì„±)
       * ============================
       */
      async function refreshEmpathyCount(postId) {
        if (!postId) return;
        const escaped = CSS?.escape?.(postId) || postId;
        try {
          const { count, error } = await sb
            .from("empathy")
            .select("id", { count: "exact", head: true })
            .eq("post_id", postId);
          if (error) {
            console.error("ê³µê° ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:", error);
            return;
          }
          const countValue = count ?? 0;
          document
            .querySelectorAll(`[data-empathy-count="${escaped}"]`)
            .forEach((el) => (el.textContent = `(${countValue})`));
        } catch (err) {
          console.error("ê³µê° ìˆ˜ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:", err);
        }
      }

      async function doEmpathy(postId) {
        if (!postId) return;
        // 1ì¸ 1íšŒ: empathy í…Œì´ë¸” unique(post_id, anon_id)
        const { error } = await sb
          .from("empathy")
          .insert({ post_id: postId, anon_id: anonId });
        if (error) {
          // ì´ë¯¸ ê³µê°í–ˆê±°ë‚˜ ì œì•½ ìœ„ë°˜
          if (
            error.code === "23505" ||
            error.code === "PGRST116" ||
            error.status === 409 ||
            String(error.message || "")
              .toLowerCase()
              .includes("duplicate") ||
            String(error.message || "")
              .toLowerCase()
              .includes("unique constraint")
          ) {
            toast("ì´ë¯¸ ê³µê°í–ˆì–´ ğŸ‘€");
            await refreshEmpathyCount(postId);
            return;
          }
          toast("ê³µê° ì‹¤íŒ¨: " + (error.message || "unknown"));
          return;
        }
        toast("ê³µê° +1 ğŸ”¥");
        await refreshEmpathyCount(postId);
      }

      async function doReport(targetType, targetId) {
        const reason = prompt("ì‹ ê³  ì‚¬ìœ (ì„ íƒ, 200ì ì´ë‚´):", "");
        const payload = {
          target_type: targetType,
          target_id: targetId,
          anon_id: anonId,
          reason: (reason || "").slice(0, 200),
        };
        const { error } = await sb.from("reports").insert(payload);
        if (error) {
          if (
            String(error.message || "")
              .toLowerCase()
              .includes("duplicate")
          ) {
            toast("ì´ë¯¸ ì‹ ê³ í–ˆì–´.");
            return;
          }
          toast("ì‹ ê³  ì‹¤íŒ¨: " + (error.message || "unknown"));
          return;
        }
        toast("ì‹ ê³  ì™„ë£Œ. ê³ ë§ˆì›Œ ğŸ™");
      }

      async function createBoard({ slug, title, description, tags }) {
        const { error } = await sb.from("boards").insert({
          slug,
          title,
          description,
          tags,
        });
        if (error) throw error;
      }

      async function createPost({ boardId, body, authorName }) {
        const { error } = await sb.from("posts").insert({
          board_id: boardId,
          body,
          author_name: authorName || "ìµëª…",
          anon_id: anonId,
        });
        if (error) throw error;
      }

      async function createComment({ postId, body, authorName }) {
        if (!postId) {
          throw new Error("ê¸€ IDê°€ ì—†ì–´. ìƒˆë¡œê³ ì¹¨í•´ì¤˜.");
        }

        // postIdë¥¼ ë¬¸ìì—´ë¡œ ëª…ì‹œì ìœ¼ë¡œ ë³€í™˜ (UUID í˜•ì‹ ìœ ì§€)
        const normalizedPostId = String(postId).trim();

        // ë””ë²„ê¹…: postId ê°’ í™•ì¸
        console.log("ëŒ“ê¸€ ì‘ì„± ì‹œë„ - postId:", {
          original: postId,
          normalized: normalizedPostId,
          type: typeof postId,
          normalizedType: typeof normalizedPostId,
        });

        // ë¨¼ì € postIdê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        const { data: postExists, error: checkError } = await sb
          .from("posts")
          .select("id, is_hidden")
          .eq("id", normalizedPostId)
          .maybeSingle();

        console.log("postId ì¡´ì¬ ì‚¬ì „ í™•ì¸:", {
          postExists,
          checkError,
          exists: !!postExists,
        });

        if (checkError) {
          console.error("postId í™•ì¸ ì¤‘ ì—ëŸ¬:", checkError);
          throw new Error(
            `ê¸€ì„ í™•ì¸í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´. (${
              checkError.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"
            })`
          );
        }

        if (!postExists) {
          throw new Error(`ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ì–´. ìƒˆë¡œê³ ì¹¨ í•´ì¤˜.`);
        }

        if (postExists.is_hidden) {
          throw new Error("ì´ ê¸€ì€ ìˆ¨ê²¨ì§„ ê¸€ì´ë¼ ëŒ“ê¸€ì„ ë‹¬ ìˆ˜ ì—†ì–´.");
        }

        // postId í™•ì¸ ì„±ê³µ ë¡œê·¸
        console.log("postId í™•ì¸ ì„±ê³µ:", {
          postId: normalizedPostId,
          isHidden: postExists.is_hidden,
          postExistsId: postExists.id,
          postExistsIdType: typeof postExists.id,
        });

        // postExists.idë¥¼ ì‚¬ìš©í•˜ì—¬ ì •í™•í•œ postId í™•ë³´
        // (normalizedPostIdì™€ postExists.idê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
        const actualPostId = postExists.id || normalizedPostId;

        // INSERT ì „ ìµœì¢… í™•ì¸: postIdë¥¼ ì§ì ‘ í…ŒìŠ¤íŠ¸
        console.log("INSERT ì „ ìµœì¢… í™•ì¸:", {
          normalizedPostId,
          actualPostId,
          postExistsId: postExists?.id,
          idsMatch: String(postExists?.id) === String(actualPostId),
          willUsePostId: actualPostId,
        });

        const { data, error } = await sb
          .from("comments")
          .insert({
            post_id: actualPostId, // postExists.idë¥¼ ì‚¬ìš©í•˜ì—¬ ì •í™•í•œ UUID ë³´ì¥
            content: body,
            author_name: authorName || "ìµëª…",
            anon_id: anonId,
          })
          .select();
        if (error) {
          // ì „ì²´ ì—ëŸ¬ ê°ì²´ ë¡œê¹… (ë” ìƒì„¸í•˜ê²Œ)
          console.error("ëŒ“ê¸€ ì‘ì„± ì—ëŸ¬ ìƒì„¸:", {
            error,
            errorString: JSON.stringify(error, null, 2),
            originalPostId: postId,
            normalizedPostId: normalizedPostId,
            actualPostId: actualPostId,
            postExistsId: postExists?.id,
            postExistsIdString: String(postExists?.id),
            status: error.status,
            code: error.code,
            message: error.message,
            details: error.details,
            hint: error.hint,
            // Supabase ì—ëŸ¬ì˜ ëª¨ë“  ì†ì„± í™•ì¸
            allKeys: Object.keys(error),
            // ì¶”ê°€ ë””ë²„ê¹… ì •ë³´
            insertPayload: {
              post_id: actualPostId,
              content: body?.slice(0, 50) + "...",
              author_name: authorName || "ìµëª…",
              anon_id: anonId?.slice(0, 8) + "...",
            },
          });

          const errorMsg = (error.message || "").toLowerCase();
          const errorCode = error.code;
          const errorDetails = error.details || "";
          const errorHint = error.hint || "";

          // ëª¨ë“  ì—ëŸ¬ë¥¼ ë¨¼ì € ë¡œê¹…
          console.error("=== ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨ - ì—ëŸ¬ ë¶„ì„ ===");
          console.error("ì—ëŸ¬ ì½”ë“œ:", errorCode);
          console.error("HTTP ìƒíƒœ:", error.status);
          console.error("ì—ëŸ¬ ë©”ì‹œì§€:", error.message);
          console.error("ì—ëŸ¬ ìƒì„¸:", errorDetails);
          console.error("ì—ëŸ¬ íŒíŠ¸:", errorHint);
          console.error("postId:", normalizedPostId);
          console.error("postExists:", postExists);
          console.error("================================");

          // ì™¸ë˜ í‚¤ ì œì•½ ìœ„ë°˜ ì—ëŸ¬ ì²˜ë¦¬ (ì—ëŸ¬ ì½”ë“œ 23503) - ìµœìš°ì„  ì²˜ë¦¬
          if (
            errorCode === "23503" ||
            error.status === 409 ||
            errorMsg.includes("foreign key constraint") ||
            errorMsg.includes("violates foreign key constraint") ||
            errorMsg.includes("comments_post_id_fkey") ||
            errorDetails.includes("Key is not present in table")
          ) {
            // postIdëŠ” ì´ë¯¸ ì¡´ì¬ í™•ì¸í–ˆì§€ë§Œ, RLS ì •ì±… ë¬¸ì œì¼ ìˆ˜ ìˆìŒ
            // ì—ëŸ¬ detailsì— "Key is not present in table"ì´ ìˆìœ¼ë©´ RLS ì •ì±… ë¬¸ì œ
            console.error("ì™¸ë˜ í‚¤ ì œì•½ ìœ„ë°˜ ë°œìƒ:", {
              originalPostId: postId,
              normalizedPostId: normalizedPostId,
              actualPostId: actualPostId,
              postExists: true, // ì´ë¯¸ í™•ì¸í•¨
              postExistsId: postExists?.id,
              errorDetails,
              errorHint,
              possibleCause:
                "RLS ì •ì±… ë¬¸ì œ ë˜ëŠ” postId íƒ€ì… ë¶ˆì¼ì¹˜ - comments í…Œì´ë¸” INSERT ì‹œ posts í…Œì´ë¸” ì°¸ì¡° ê¶Œí•œ ì—†ìŒ",
            });

            // RLS ì •ì±… ë¬¸ì œì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŒ
            // comments í…Œì´ë¸” INSERT ì‹œ posts í…Œì´ë¸”ì˜ í•´ë‹¹ í–‰ì„ ì°¸ì¡°í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì´ ì—†ìŒ
            if (errorDetails.includes("Key is not present in table")) {
              const rlsGuide = `
RLS ì •ì±… ì„¤ì • ê°€ì´ë“œ (Supabase SQL Editorì—ì„œ ì‹¤í–‰):

-- ê¸°ì¡´ comments INSERT ì •ì±…ë“¤ ëª¨ë‘ ì‚­ì œ
DROP POLICY IF EXISTS "Anyone can create comments" ON comments;
DROP POLICY IF EXISTS "anon insert comments" ON comments;
DROP POLICY IF EXISTS "insert_comments" ON comments;
DROP POLICY IF EXISTS "Allow anon to insert comments" ON comments;

-- comments í…Œì´ë¸” INSERT ì •ì±… ìƒì„± (public ì—­í•  ì‚¬ìš©)
CREATE POLICY "Allow anon to insert comments"
ON comments FOR INSERT
TO public
WITH CHECK (
  EXISTS (
    SELECT 1 FROM posts 
    WHERE posts.id = comments.post_id
  )
);

-- ì •ì±… í™•ì¸
SELECT * FROM pg_policies WHERE tablename = 'comments';
SELECT * FROM pg_policies WHERE tablename = 'posts' AND cmd = 'SELECT';
`;
              console.error("RLS ì •ì±… ì„¤ì • ê°€ì´ë“œ:", rlsGuide);
              console.error(
                "ê´€ë¦¬ììš©: Supabase ëŒ€ì‹œë³´ë“œ â†’ SQL Editorì—ì„œ ìœ„ SQLì„ ì‹¤í–‰í•˜ì„¸ìš”."
              );
              console.error("í˜„ì¬ ì—ëŸ¬ ìƒì„¸:", {
                errorCode,
                errorStatus: error.status,
                errorDetails,
                errorHint,
                errorMessage: error.message,
                actualPostId: actualPostId,
                postExistsId: postExists?.id,
              });

              // ì‚¬ìš©ìì—ê²ŒëŠ” ê°„ë‹¨í•œ ë©”ì‹œì§€ë§Œ í‘œì‹œ
              throw new Error(
                `ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ì–´. ìƒˆë¡œê³ ì¹¨ í•´ì¤˜. (ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ë¬¸ì œì¼ ìˆ˜ ìˆì–´)`
              );
            }

            // ì¼ë°˜ì ì¸ ì™¸ë˜ í‚¤ ì œì•½ ìœ„ë°˜
            throw new Error(`ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ì–´. ìƒˆë¡œê³ ì¹¨ í•´ì¤˜.`);
          }

          // ì¤‘ë³µ ì œì•½ ì¡°ê±´ ìœ„ë°˜ (Unique constraint violation) - ì—ëŸ¬ ì½”ë“œ 23505
          if (
            errorCode === "23505" ||
            errorCode === "PGRST116" ||
            errorMsg.includes("duplicate") ||
            errorMsg.includes("unique constraint") ||
            errorMsg.includes("violates unique constraint")
          ) {
            throw new Error("ì¤‘ë³µëœ ìš”ì²­ì´ì•¼. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì¤˜.");
          }

          // 409 Conflict HTTP ìƒíƒœ ì½”ë“œ ì²˜ë¦¬
          // SupabaseëŠ” ì¼ë¶€ ì œì•½ ì¡°ê±´ ìœ„ë°˜ì„ 409ë¡œ ë°˜í™˜í•  ìˆ˜ ìˆìŒ
          if (error.status === 409 || errorCode === "409") {
            // ì—ëŸ¬ ë©”ì‹œì§€ì— ë”°ë¼ êµ¬ì²´ì ì¸ ì•ˆë‚´
            if (
              errorMsg.includes("foreign key") ||
              errorDetails.includes("Key is not present in table")
            ) {
              // RLS ì •ì±… ë¬¸ì œ ë˜ëŠ” ì™¸ë˜ í‚¤ ì œì•½ ìœ„ë°˜
              // postId í™•ì¸ì€ ì„±ê³µí–ˆì§€ë§Œ INSERT ì‹œì ì— ì‹¤íŒ¨
              throw new Error(
                `ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ì–´. ìƒˆë¡œê³ ì¹¨ í•´ì¤˜. (RLS ì •ì±… ë˜ëŠ” ì™¸ë˜ í‚¤ ì œì•½ ë¬¸ì œì¼ ìˆ˜ ìˆì–´)`
              );
            }
            if (errorMsg.includes("duplicate") || errorMsg.includes("unique")) {
              throw new Error("ì¤‘ë³µëœ ìš”ì²­ì´ì•¼. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì¤˜.");
            }
            // ì¼ë°˜ì ì¸ 409 ì—ëŸ¬ - ê¸€ ì •ë³´ê°€ ìµœì‹ ì´ ì•„ë‹ ìˆ˜ ìˆìŒ
            throw new Error(`ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ì–´. ìƒˆë¡œê³ ì¹¨ í•´ì¤˜.`);
          }

          // ê¸°íƒ€ ì—ëŸ¬ - ì›ë³¸ ë©”ì‹œì§€ í¬í•¨
          const userMessage = error.message || "ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆì–´.";
          throw new Error(
            `${userMessage} (ì—ëŸ¬ ì½”ë“œ: ${errorCode || "ì•Œ ìˆ˜ ì—†ìŒ"})`
          );
        }
        return data;
      }

      /**
       * ============================
       * âœ… 9) í† ìŠ¤íŠ¸
       * ============================
       */
      let toastTimer = null;
      function toast(msg) {
        let el = document.getElementById("toast");
        if (!el) {
          el = document.createElement("div");
          el.id = "toast";
          el.className =
            "fixed left-1/2 -translate-x-1/2 bottom-6 z-[60] px-4 py-3 rounded-2xl bg-black/60 border border-white/10 backdrop-blur-xl text-sm soft";
          document.body.appendChild(el);
        }
        el.textContent = msg;
        el.style.display = "block";
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => (el.style.display = "none"), 1400);
      }

      /**
       * ============================
       * âœ… 10) ë·° ë Œë”
       * ============================
       */
      function skeletonList(n = 6) {
        return `
    <div class="space-y-3">
      ${Array.from({ length: n })
        .map(
          () => `
        <div class="glass rounded-2xl border border-white/10 p-4 skeleton">
          <div class="h-3 w-40 bg-white/10 rounded"></div>
          <div class="mt-3 h-4 w-full bg-white/10 rounded"></div>
          <div class="mt-2 h-4 w-5/6 bg-white/10 rounded"></div>
          <div class="mt-4 h-9 w-44 bg-white/10 rounded-xl"></div>
        </div>
      `
        )
        .join("")}
    </div>
  `;
      }

      async function renderHome() {
        viewEl.innerHTML = `
    <section class="mt-4">
      <div class="flex items-center justify-between gap-3">
        <h2 class="text-lg font-extrabold">ğŸ  í”¼ë“œ</h2>
        <div class="flex items-center gap-2">
          <button id="openBoardsQuick" class="tap text-sm px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15">ì‚´ì•„ìˆëŠ” íŒ</button>
          <button id="openComposeQuick" class="tap text-sm px-3 py-2 rounded-xl bg-sky-400/20 border border-sky-300/30 hover:bg-sky-400/25">ê¸€ì“°ê¸°</button>
        </div>
      </div>

      <div class="mt-3 glass rounded-2xl p-4 border border-white/10">
        <p class="text-sm text-slate-300">
          ìµœì‹  ê¸€ì´ íë¥´ëŠ” ê³³. <span class="text-slate-100 font-semibold">íŒ(ì£¼ì œ)</span>ì„ ëˆŒëŸ¬ ë” ê¹Šê²Œ ë“¤ì–´ê°€.
        </p>
      </div>

      <div id="feedList" class="mt-4 space-y-3">
        ${skeletonList(7)}
      </div>
    </section>
  `;

        $("#openComposeQuick").addEventListener("click", openCompose);
        $("#openBoardsQuick").addEventListener("click", () => nav("/boards"));

        const feed = await fetchFeed({ limit: 30 });
        const list = feed.length
          ? feed.map(postCard).join("")
          : cardShell(`<div class="p-6 text-center">
        <p class="text-slate-300">ì•„ì§ ê¸€ì´ ì—†ì–´. ì²« ê¸€ì„ ë‚¨ê²¨ë³¼ë˜?</p>
        <button class="tap mt-4 px-4 py-2 rounded-xl bg-sky-400/20 border border-sky-300/30 hover:bg-sky-400/25 font-bold" onclick="document.getElementById('openComposeBtn').click()">âœï¸ ì²« ê¸€ ì“°ê¸°</button>
      </div>`);

        $("#feedList").innerHTML = list;

        bindPostActions();
      }

      async function renderBoards() {
        viewEl.innerHTML = `
    <section class="mt-4">
      <div class="flex items-center justify-between gap-3">
        <h2 class="text-lg font-extrabold">ğŸ§© ì‚´ì•„ìˆëŠ” íŒ</h2>
        <button class="tap text-sm px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15" onclick="location.hash='#/boards/new'">â• íŒ ë§Œë“¤ê¸°</button>
      </div>

      <div class="mt-3 glass rounded-2xl p-4 border border-white/10">
        <p class="text-sm text-slate-300">
          ìµœê·¼ 24ì‹œê°„ ë™ì•ˆ ì›€ì§ì¸ íŒë§Œ ë³´ì—¬. (ë¬´í™œë™ íŒì€ ìë™ìœ¼ë¡œ ìˆ¨ê¹€)
        </p>
      </div>

      <div id="boardsGrid" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
        ${Array.from({ length: 6 })
          .map(
            () =>
              `<div class="glass rounded-2xl border border-white/10 p-4 skeleton h-28"></div>`
          )
          .join("")}
      </div>
    </section>
  `;

        const boards = await fetchActiveBoards(40);
        $("#boardsGrid").innerHTML = boards.length
          ? boards.map(boardPill).join("")
          : cardShell(`<div class="p-6 text-center">
        <p class="text-slate-300">ì‚´ì•„ìˆëŠ” íŒì´ ì•„ì§ ì—†ì–´. ì²« íŒì„ ë§Œë“¤ì.</p>
        <a href="#/boards/new" class="tap inline-flex mt-4 px-4 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15 font-bold">â• íŒ ë§Œë“¤ê¸°</a>
      </div>`);
      }

      async function renderNewBoard() {
        viewEl.innerHTML = `
    <section class="mt-4">
      <h2 class="text-lg font-extrabold">â• íŒ ë§Œë“¤ê¸°</h2>

      <div class="mt-3 glass rounded-2xl p-4 border border-white/10">
        <p class="text-sm text-slate-300">
          íŒì€ â€œì£¼ì œâ€ë‹¤. ì‚¬ëŒ ì¤‘ì‹¬ì´ ì•„ë‹ˆë¼, ìƒê°ì´ ëª¨ì´ëŠ” ê³³.
        </p>
        <p class="mt-2 text-xs text-slate-500">
          slugëŠ” ì˜ë¬¸/ìˆ«ì/í•˜ì´í”ˆë§Œ(2~40). ì˜ˆ: <span class="text-slate-300">bitcoin-sin</span>
        </p>
      </div>

      <form id="boardForm" class="mt-4 glass rounded-2xl p-4 border border-white/10 space-y-3">
        <div class="grid sm:grid-cols-2 gap-3">
          <label class="block">
            <span class="text-xs text-slate-400">íŒ ì´ë¦„</span>
            <input id="bTitle" required maxlength="40" placeholder="ì˜ˆ: ë¹„íŠ¸ì½”ì¸ ì•ˆ ì‚° ì£„"
                   class="mt-1 w-full px-3 py-2 rounded-xl bg-black/30 border border-white/10 outline-none focus:border-sky-300/40" />
          </label>

          <label class="block">
            <span class="text-xs text-slate-400">slug (URL)</span>
            <input id="bSlug" required maxlength="40" placeholder="ì˜ˆ: bitcoin-sin"
                   class="mt-1 w-full px-3 py-2 rounded-xl bg-black/30 border border-white/10 outline-none focus:border-sky-300/40" />
          </label>
        </div>

        <label class="block">
          <span class="text-xs text-slate-400">ì„¤ëª…</span>
          <input id="bDesc" maxlength="160" placeholder="í•œ ì¤„ ì†Œê°œ"
                 class="mt-1 w-full px-3 py-2 rounded-xl bg-black/30 border border-white/10 outline-none focus:border-sky-300/40" />
        </label>

        <label class="block">
          <span class="text-xs text-slate-400">íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</span>
          <input id="bTags" maxlength="120" placeholder="ì˜ˆ: money, regret, meme"
                 class="mt-1 w-full px-3 py-2 rounded-xl bg-black/30 border border-white/10 outline-none focus:border-sky-300/40" />
          <p class="mt-1 text-xs text-slate-500">íƒœê·¸ëŠ” ì˜ì–´ë¡œ ì¶”ì²œ(ê²€ìƒ‰/ì •ë ¬ì— ì¢‹ìŒ)</p>
        </label>

        <div class="flex items-center justify-end gap-2">
          <a href="#/boards" class="tap px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15">ì·¨ì†Œ</a>
          <button class="tap px-4 py-2 rounded-xl bg-sky-400/20 border border-sky-300/30 hover:bg-sky-400/25 font-bold" type="submit">ìƒì„±</button>
        </div>

        <p id="boardErr" class="hidden text-xs text-rose-300"></p>
      </form>
    </section>
  `;

        const form = $("#boardForm");
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const title = $("#bTitle").value.trim();
          const slug = $("#bSlug").value.trim().toLowerCase();
          const description = $("#bDesc").value.trim();
          const tags = $("#bTags")
            .value.split(",")
            .map((s) => s.trim())
            .filter(Boolean)
            .slice(0, 12);

          $("#boardErr").classList.add("hidden");
          try {
            if (!/^[a-z0-9-]{2,40}$/.test(slug)) {
              throw new Error(
                "slug í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„. ì˜ë¬¸/ìˆ«ì/í•˜ì´í”ˆë§Œ(2~40)"
              );
            }
            await createBoard({ slug, title, description, tags });
            toast("íŒ ìƒì„± ì™„ë£Œ âœ…");
            // íŒ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™í•˜ì—¬ ìƒˆë¡œ ìƒì„±í•œ íŒì´ ë°”ë¡œ ë³´ì´ë„ë¡ í•¨
            nav("/boards");
            // íŒ ëª©ë¡ì„ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ìƒˆë¡œ ìƒì„±í•œ íŒì´ í‘œì‹œë˜ë„ë¡ í•¨
            setTimeout(() => render(), 100);
          } catch (err) {
            $("#boardErr").textContent = err?.message || String(err);
            $("#boardErr").classList.remove("hidden");
          }
        });
      }

      async function renderBoard(slug) {
        viewEl.innerHTML = `
    <section class="mt-4">
      <div class="glass rounded-2xl p-4 border border-white/10 soft">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div>
            <div class="text-xs text-slate-400">íŒ</div>
            <h2 id="boardTitle" class="text-xl font-extrabold">${esc(slug)}</h2>
            <p id="boardDesc" class="mt-1 text-sm text-slate-300">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>

          <div class="flex items-center gap-2">
            <button class="tap px-3 py-2 rounded-xl bg-sky-400/20 border border-sky-300/30 hover:bg-sky-400/25" id="composeInBoard">âœï¸ ì´ íŒì— ê¸€ì“°ê¸°</button>
            <a href="#/boards" class="tap px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15">ë‹¤ë¥¸ íŒ</a>
          </div>
        </div>
      </div>

      <div id="boardFeed" class="mt-4 space-y-3">${skeletonList(6)}</div>
    </section>
  `;

        $("#composeInBoard").addEventListener("click", async () => {
          await openCompose(slug);
        });

        // board info
        const { data: b, error: e1 } = await sb
          .from("boards")
          .select(
            "id, slug, title, description, tags, is_active, last_activity_at"
          )
          .eq("slug", slug)
          .maybeSingle();

        if (e1) {
          $("#boardDesc").textContent = "íŒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´.";
        } else if (!b) {
          viewEl.innerHTML = cardShell(`
      <div class="p-6 text-center">
        <p class="text-slate-300">ì´ íŒì€ ì•„ì§ ì—†ì–´. ë§Œë“¤ë˜?</p>
        <div class="mt-4 flex justify-center gap-2">
          <a href="#/boards/new" class="tap px-4 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15 font-bold">â• íŒ ë§Œë“¤ê¸°</a>
          <a href="#/" class="tap px-4 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10">í”¼ë“œë¡œ</a>
        </div>
      </div>
    `);
          return;
        } else {
          $("#boardTitle").textContent = b.title;
          $("#boardDesc").textContent = b.description || "";
        }

        const feed = await fetchFeed({ limit: 30, boardSlug: slug });
        $("#boardFeed").innerHTML = feed.length
          ? feed.map(postCard).join("")
          : cardShell(`
    <div class="p-6 text-center">
      <p class="text-slate-300">ì•„ì§ ì´ íŒì— ê¸€ì´ ì—†ì–´. ì²« ê¸€ì„ ë‚¨ê²¨ì¤˜.</p>
      <button class="tap mt-4 px-4 py-2 rounded-xl bg-sky-400/20 border border-sky-300/30 hover:bg-sky-400/25 font-bold" onclick="document.getElementById('composeInBoard').click()">âœï¸ ì²« ê¸€ ì“°ê¸°</button>
    </div>
  `);

        bindPostActions();
      }

      async function renderPost(postId) {
        if (!postId) {
          viewEl.innerHTML = cardShell(
            `<div class="p-6 text-center text-slate-300">ê¸€ IDê°€ ì—†ì–´.</div>`
          );
          return;
        }

        viewEl.innerHTML = `
    <section class="mt-4">
      <div class="glass rounded-2xl p-4 border border-white/10 soft">
        <div id="postWrap">${skeletonList(1)}</div>
      </div>
      <div id="commentsWrap" class="mt-4">${skeletonList(4)}</div>
    </section>
  `;

        let post, comments;
        try {
          ({ post, comments } = await fetchPostDetail(postId));
        } catch (err) {
          viewEl.innerHTML = cardShell(`
      <div class="p-6">
        <h3 class="font-extrabold text-lg">ì—ëŸ¬</h3>
        <p class="mt-2 text-sm text-slate-300">ê¸€ì„ ë¶ˆëŸ¬ì˜¤ë‹¤ê°€ ë¬¸ì œê°€ ìƒê²¼ì–´.</p>
        <pre class="mt-3 text-xs text-rose-200 whitespace-pre-wrap bg-black/30 border border-white/10 rounded-2xl p-3 overflow-auto">${esc(
          err?.message || String(err)
        )}</pre>
        <div class="mt-4 flex gap-2">
          <button class="tap px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15" onclick="location.hash='#/'">í”¼ë“œë¡œ</button>
          <button class="tap px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15" onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>
    `);
          return;
        }
        if (!post) {
          viewEl.innerHTML = cardShell(
            `<div class="p-6 text-center">
              <p class="text-slate-300 mb-4">ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ì–´. ìƒˆë¡œê³ ì¹¨ í•´ì¤˜.</p>
              <div class="flex gap-2 justify-center">
                <button class="tap px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15" onclick="location.hash='#/'">í”¼ë“œë¡œ</button>
                <button class="tap px-3 py-2 rounded-xl bg-sky-400/20 border border-sky-300/30 hover:bg-sky-400/25" onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
              </div>
            </div>`
          );
          return;
        }

        const board = post.board || {};
        const nick = post.author_name || "ìµëª…";

        $("#postWrap").innerHTML = `
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <div class="flex flex-wrap items-center gap-2 text-xs text-slate-400">
          <span class="px-2 py-1 rounded-full bg-white/10 border border-white/10">${esc(
            nick
          )}</span>
          <span>Â·</span>
          <span>${esc(timeAgo(post.created_at))}</span>
          <span class="hidden sm:inline">Â·</span>
          <a class="tap hidden sm:inline-flex items-center gap-1 px-2 py-1 rounded-full bg-white/5 border border-white/10 hover:bg-white/10"
             href="#/g/${esc(board.slug || "")}">
            ğŸ“Œ <span class="truncate max-w-[220px]">${esc(
              board.title || "íŒ"
            )}</span>
          </a>
        </div>
        <div class="mt-3 text-base leading-relaxed whitespace-pre-wrap">${esc(
          post.body
        )}</div>

        <div class="mt-4 flex flex-wrap items-center gap-2">
          <button class="tap empathyBtn px-3 py-2 rounded-xl bg-rose-400/10 border border-rose-300/20 hover:bg-rose-400/15 text-sm"
                  data-post="${esc(post.id)}">
            ğŸ”¥ ê³µê° <span class="opacity-80" data-empathy-count="${esc(
              post.id
            )}">(${Number(post.empathy_count || 0)})</span>
          </button>

          <a href="#/g/${esc(
            board.slug || ""
          )}" class="tap px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15 text-sm">
            ğŸ§© íŒìœ¼ë¡œ
          </a>

          <button class="tap reportBtn ml-auto px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 text-sm"
                  data-type="post" data-id="${esc(post.id)}">
            ğŸš« ì‹ ê³ 
          </button>
        </div>
      </div>

      <img src="${seedImg(
        (board.slug || "board") + "-" + post.id
      )}" alt="post image"
           class="hidden sm:block w-40 h-28 rounded-2xl object-cover border border-white/10 opacity-95" />
    </div>
  `;

        bindPostActions();
        // ê³µê° ìˆ˜ ì´ˆê¸° ë¡œë“œ ì‹œ ìƒˆë¡œê³ ì¹¨
        if (post && post.id) {
          refreshEmpathyCount(post.id).catch(() => {});
        }

        $("#commentsWrap").innerHTML = `
    <div class="glass rounded-2xl p-4 border border-white/10 soft">
      <div class="flex items-center justify-between">
        <h3 class="font-extrabold">ğŸ’¬ ëŒ“ê¸€</h3>
        <span class="text-xs text-slate-400">${comments.length}ê°œ</span>
      </div>

      <form id="commentForm" class="mt-3 grid gap-2">
        <div class="grid sm:grid-cols-2 gap-2">
          <input id="cName" maxlength="20" placeholder="ë‹‰ë„¤ì„(ì„ íƒ)"
                 value="${esc(getLastName())}"
                 class="w-full px-3 py-2 rounded-xl bg-black/30 border border-white/10 outline-none focus:border-sky-300/40" />
          <button type="submit" id="cSubmit" class="tap w-full px-3 py-2 rounded-xl bg-sky-400/20 border border-sky-300/30 hover:bg-sky-400/25 font-bold text-sm">ë“±ë¡</button>
        </div>

        <textarea id="cBody" rows="3" maxlength="2000" placeholder="í•œ ì¤„ ë˜ì ¸â€¦"
                  class="w-full px-3 py-2 rounded-xl bg-black/30 border border-white/10 outline-none focus:border-sky-300/40"></textarea>
        <div class="flex justify-between text-xs text-slate-500">
          <span id="cHint"></span>
          <span id="cCount">0/2000</span>
        </div>

        <p id="cErr" class="hidden text-xs text-rose-300"></p>
      </form>

      <div class="mt-4 space-y-2" id="commentList">
        ${
          comments.length
            ? comments
                .map(
                  (c) => `
              <div class="rounded-2xl bg-white/5 border border-white/10 p-3">
                <div class="flex items-center justify-between text-xs text-slate-400">
                  <div class="flex items-center gap-2">
                    <span class="px-2 py-1 rounded-full bg-white/10 border border-white/10">${esc(
                      c.author_name || "ìµëª…"
                    )}</span>
                    <span>Â·</span>
                    <span>${esc(timeAgo(c.created_at))}</span>
                  </div>
                  <button class="tap reportBtn px-2 py-1 rounded-full bg-white/10 border border-white/10 hover:bg-white/15"
                          data-type="comment" data-id="${esc(
                            c.id
                          )}">ì‹ ê³ </button>
                </div>
                <div class="mt-2 text-sm leading-relaxed whitespace-pre-wrap">${esc(
                  c.body
                )}</div>
              </div>
            `
                )
                .join("")
            : `<div class="text-sm text-slate-400 text-center py-6">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ì¤˜.</div>`
        }
      </div>
    </div>
  `;

        // comment counter
        const cBody = $("#cBody");
        const cCount = $("#cCount");
        const cHint = $("#cHint");
        const cErr = $("#cErr");

        // postIdë¥¼ ì•ˆì „í•˜ê²Œ ì €ì¥ (í´ë¡œì € ë¬¸ì œ ë°©ì§€)
        // post.idê°€ ì˜¬ë°”ë¥¸ í˜•ì‹ì¸ì§€ í™•ì¸
        const currentPostId = post.id;
        const currentPost = post;

        console.log("renderPost - post ê°ì²´:", {
          post,
          postId: post.id,
          postIdType: typeof post.id,
          postIdString: String(post.id),
        });

        function updateCCount() {
          cCount.textContent = `${(cBody.value || "").length}/2000`;
          const left = msLeft(LS_COOLDOWN_COMMENT);
          const isMac = navigator.platform.toUpperCase().indexOf("MAC") >= 0;
          const shortcutHint = isMac
            ? "âŒ¨ï¸ Shift+Enter ë˜ëŠ” âŒ˜+Enterë¡œ ë“±ë¡"
            : "âŒ¨ï¸ Shift+Enter ë˜ëŠ” Ctrl+Enterë¡œ ë“±ë¡";
          cHint.innerHTML =
            left > 0
              ? `<span class="text-rose-300">${Math.ceil(
                  left / 1000
                )}ì´ˆ ë’¤ ë“±ë¡ ê°€ëŠ¥</span>`
              : `<span class="text-slate-400">${shortcutHint}</span>`;
        }
        cBody.addEventListener("input", updateCCount);
        updateCCount();

        // ëŒ“ê¸€ ì œì¶œ í•¨ìˆ˜ ë¶„ë¦¬
        async function submitComment() {
          cErr.classList.add("hidden");

          const submitBtn = $("#cSubmit");
          const name = ($("#cName").value || "").trim().slice(0, 20) || "ìµëª…";
          const body = (cBody.value || "").trim();

          // ì¤‘ë³µ ì œì¶œ ë°©ì§€
          if (submitBtn.disabled) return;

          try {
            if (!body) throw new Error("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì¤˜.");
            if (inCooldown(LS_COOLDOWN_COMMENT, 8000)) {
              const left = Math.ceil(msLeft(LS_COOLDOWN_COMMENT) / 1000);
              throw new Error(`ì ê¹ë§Œâ€¦ ëŒ“ê¸€ ì¿¨íƒ€ì„ ${left}ì´ˆ ë‚¨ì•˜ì–´.`);
            }

            // ì €ì¥ëœ postId ì‚¬ìš©
            if (!currentPostId) {
              console.error("postId í™•ì¸:", {
                currentPostId,
                currentPost,
                postId,
                post,
              });
              throw new Error("ê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´. ìƒˆë¡œê³ ì¹¨í•´ì¤˜.");
            }

            console.log(
              "ëŒ“ê¸€ ì œì¶œ - postId:",
              currentPostId,
              "post ê°ì²´:",
              currentPost
            );

            // ë²„íŠ¼ ë¹„í™œì„±í™”
            submitBtn.disabled = true;
            submitBtn.textContent = "ë“±ë¡ ì¤‘...";

            setCooldown(LS_COOLDOWN_COMMENT, 8000);
            setLastName(name);

            await createComment({
              postId: currentPostId,
              body,
              authorName: name,
            });
            toast("ëŒ“ê¸€ ë“±ë¡ âœ…");
            render();
          } catch (err) {
            console.error("ëŒ“ê¸€ ì œì¶œ ì—ëŸ¬:", err);
            const errorMessage = err?.message || String(err);
            cErr.classList.remove("hidden");

            // "ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ì–´" ë˜ëŠ” "ìƒˆë¡œê³ ì¹¨" ë©”ì‹œì§€ê°€ í¬í•¨ëœ ê²½ìš°
            // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ê³¼ í•¨ê»˜ í‘œì‹œ
            if (
              errorMessage.includes("ìƒˆë¡œê³ ì¹¨") ||
              errorMessage.includes("ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ì–´")
            ) {
              cErr.innerHTML = `
                <span>${esc(errorMessage)}</span>
                <button class="tap ml-2 px-2 py-1 rounded-lg bg-sky-400/20 border border-sky-300/30 hover:bg-sky-400/25 text-xs" onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
              `;
            } else {
              cErr.textContent = errorMessage;
            }

            // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
            submitBtn.disabled = false;
            submitBtn.textContent = "ë“±ë¡";
          }
        }

        // í¼ ì œì¶œ ì´ë²¤íŠ¸
        $("#commentForm").addEventListener("submit", async (e) => {
          e.preventDefault();
          await submitComment();
        });

        // ë‹¨ì¶•í‚¤: Shift+Enter ë˜ëŠ” Cmd+Enter (Mac) / Ctrl+Enter (Windows/Linux)
        cBody.addEventListener("keydown", (e) => {
          const isMac = navigator.platform.toUpperCase().indexOf("MAC") >= 0;
          const isCmdOrCtrl = isMac ? e.metaKey : e.ctrlKey;

          if (e.key === "Enter" && (e.shiftKey || isCmdOrCtrl)) {
            e.preventDefault();
            submitComment();
          }
        });

        // bind report buttons in comments
        document.querySelectorAll(".reportBtn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const t = btn.dataset.type;
            const id = btn.dataset.id;
            await doReport(t, id);
          });
        });
      }

      function bindPostActions() {
        document.querySelectorAll(".empathyBtn").forEach((btn) => {
          const postId = btn.dataset.post;
          if (postId) {
            // ì´ˆê¸° ë¡œë“œ ì‹œ ê³µê° ìˆ˜ ìƒˆë¡œê³ ì¹¨ (ë¹„ë™ê¸°, ì—ëŸ¬ ë¬´ì‹œ)
            refreshEmpathyCount(postId).catch(() => {});
          }
          btn.addEventListener("click", async () => {
            await doEmpathy(postId);
          });
        });

        document.querySelectorAll(".reportBtn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const t = btn.dataset.type;
            const id = btn.dataset.id;
            await doReport(t, id);
          });
        });
      }

      /**
       * ============================
       * âœ… 11) ê¸€ì“°ê¸° ëª¨ë‹¬
       * ============================
       */
      const composeModal = $("#composeModal");
      const composeBoardSel = $("#composeBoard");
      const composeName = $("#composeName");
      const composeBody = $("#composeBody");
      const composeCount = $("#composeCount");
      const composeHint = $("#composeHint");
      const composeError = $("#composeError");

      function openCompose(preselectSlug = null) {
        composeError.classList.add("hidden");
        composeName.value = getLastName();
        composeBody.value = "";
        composeCount.textContent = "0/8000";

        composeModal.classList.remove("hidden");
        document.body.style.overflow = "hidden";
        loadComposeBoards(preselectSlug);
        updateComposeHint();
      }
      function closeCompose() {
        composeModal.classList.add("hidden");
        document.body.style.overflow = "";
      }
      function updateComposeHint() {
        const left = msLeft(LS_COOLDOWN_POST);
        const isMac = navigator.platform.toUpperCase().indexOf("MAC") >= 0;
        const shortcutHint = isMac
          ? "âŒ¨ï¸ Shift+Enter ë˜ëŠ” âŒ˜+Enterë¡œ ê²Œì‹œ"
          : "âŒ¨ï¸ Shift+Enter ë˜ëŠ” Ctrl+Enterë¡œ ê²Œì‹œ";
        composeHint.innerHTML =
          left > 0
            ? `<span class="text-rose-300">${Math.ceil(
                left / 1000
              )}ì´ˆ ë’¤ ê²Œì‹œ ê°€ëŠ¥</span>`
            : `<span class="text-slate-400">${shortcutHint}</span>`;
      }

      async function loadComposeBoards(preselectSlug) {
        composeBoardSel.innerHTML = `<option value="">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>`;
        try {
          const boards = await fetchBoardsForSelect();
          if (!boards.length) {
            composeBoardSel.innerHTML = `<option value="">íŒì´ ì—†ì–´. ë¨¼ì € íŒì„ ë§Œë“¤ì–´ì¤˜.</option>`;
            return;
          }
          composeBoardSel.innerHTML = boards
            .map((b) => {
              const selected =
                preselectSlug && b.slug === preselectSlug ? "selected" : "";
              return `<option value="${esc(b.id)}" data-slug="${esc(
                b.slug
              )}" ${selected}>${esc(b.title)} (#${esc(b.slug)})</option>`;
            })
            .join("");
        } catch (err) {
          composeBoardSel.innerHTML = `<option value="">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</option>`;
        }
      }

      $("#openComposeBtn").addEventListener("click", () => openCompose());
      $("#closeComposeBtn").addEventListener("click", closeCompose);
      composeModal.addEventListener("click", (e) => {
        if (e.target === composeModal) closeCompose();
        if (
          e.target?.classList?.contains("absolute") &&
          e.target?.classList?.contains("inset-0")
        )
          closeCompose();
      });

      $("#goNewBoardBtn").addEventListener("click", () => {
        closeCompose();
        nav("/boards/new");
      });

      composeBody.addEventListener("input", () => {
        composeCount.textContent = `${(composeBody.value || "").length}/8000`;
      });

      // ê²Œì‹œ í•¨ìˆ˜ ë¶„ë¦¬
      async function submitPost() {
        composeError.classList.add("hidden");
        try {
          const boardId = composeBoardSel.value;
          const name = (composeName.value || "").trim().slice(0, 20) || "ìµëª…";
          const body = (composeBody.value || "").trim();

          if (!boardId) throw new Error("íŒì„ ì„ íƒí•´ì¤˜.");
          if (!body) throw new Error("ë³¸ë¬¸ì„ ì…ë ¥í•´ì¤˜.");

          if (inCooldown(LS_COOLDOWN_POST, 20000)) {
            const left = Math.ceil(msLeft(LS_COOLDOWN_POST) / 1000);
            throw new Error(`ì ê¹ë§Œâ€¦ ê¸€ ì¿¨íƒ€ì„ ${left}ì´ˆ ë‚¨ì•˜ì–´.`);
          }
          setCooldown(LS_COOLDOWN_POST, 20000);
          setLastName(name);

          await createPost({ boardId, body, authorName: name });
          toast("ê²Œì‹œ ì™„ë£Œ âœ…");

          closeCompose();
          // í”¼ë“œë¡œ ì´ë™í•˜ì—¬ ìƒˆë¡œ ì‘ì„±í•œ ê¸€ì´ ë°”ë¡œ ë³´ì´ë„ë¡ í•¨
          nav("/");
          // í”¼ë“œë¥¼ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ìƒˆë¡œ ì‘ì„±í•œ ê¸€ì´ í‘œì‹œë˜ë„ë¡ í•¨
          setTimeout(() => render(), 100);
        } catch (err) {
          composeError.textContent = err?.message || String(err);
          composeError.classList.remove("hidden");
        } finally {
          updateComposeHint();
        }
      }

      // ê²Œì‹œ ë²„íŠ¼ í´ë¦­
      $("#submitPostBtn").addEventListener("click", submitPost);

      // ë‹¨ì¶•í‚¤: Shift+Enter ë˜ëŠ” Cmd+Enter (Mac) / Ctrl+Enter (Windows/Linux)
      composeBody.addEventListener("keydown", (e) => {
        const isMac = navigator.platform.toUpperCase().indexOf("MAC") >= 0;
        const isCmdOrCtrl = isMac ? e.metaKey : e.ctrlKey;

        if (e.key === "Enter" && (e.shiftKey || isCmdOrCtrl)) {
          e.preventDefault();
          submitPost();
        }
      });

      /**
       * ============================
       * âœ… 12) ë©”ì¸ ë Œë”ëŸ¬
       * ============================
       */
      async function render() {
        updateComposeHint();
        await loadStats();

        const parts = parseHash();
        // routes:
        // #/                 => home
        // #/boards           => list active boards
        // #/boards/new       => create board
        // #/g/:slug          => board view
        // #/p/:id            => post detail

        try {
          if (!parts.length) return renderHome();

          if (parts[0] === "boards" && parts[1] === "new")
            return renderNewBoard();
          if (parts[0] === "boards") return renderBoards();

          if (parts[0] === "g" && parts[1]) return renderBoard(parts[1]);
          if (parts[0] === "p" && parts[1]) return renderPost(parts[1]);

          // fallback
          return renderHome();
        } catch (err) {
          viewEl.innerHTML = cardShell(`
      <div class="p-6">
        <h3 class="font-extrabold text-lg">ì—ëŸ¬</h3>
        <p class="mt-2 text-sm text-slate-300">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë‹¤ê°€ ë¬¸ì œê°€ ìƒê²¼ì–´.</p>
        <pre class="mt-3 text-xs text-rose-200 whitespace-pre-wrap bg-black/30 border border-white/10 rounded-2xl p-3 overflow-auto">${esc(
          err?.message || String(err)
        )}</pre>
        <div class="mt-4 flex gap-2">
          <button class="tap px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15" onclick="location.hash='#/'">í”¼ë“œë¡œ</button>
          <button class="tap px-3 py-2 rounded-xl bg-white/10 border border-white/10 hover:bg-white/15" onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>
    `);
        }
      }

      window.addEventListener("hashchange", render);
      render();

      /**
       * ============================
       * âœ… 13) (ì˜µì…˜) íŒ ìë™ ë¹„í™œì„±í™” ì•ˆë‚´
       * ============================
       * Supabaseì—ì„œ ìŠ¤ì¼€ì¤„(ì˜ˆ: 30ë¶„~1ì‹œê°„ë§ˆë‹¤)ë¡œ ì•„ë˜ SQLì„ ì‹¤í–‰í•˜ë©´ â€œì£½ì€ íŒ ìˆ¨ê¹€â€ì´ ì™„ì„±ë¨.
       *
       * update public.boards
       * set is_active = false
       * where last_activity_at < now() - interval '24 hours';
       */
    </script>
  </body>
</html>
